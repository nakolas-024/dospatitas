---
// src/pages/categoria/[slug].astro (CORREGIDO Y FUNCIONAL)
import Layout from '../../layouts/Layout.astro';
import ProductCard from '../../components/ProductCard.astro';
import ProductFullCard from '../../components/ProductFullCard.astro'; // Necesario para el modal
import { supabase } from '../../lib/supabaseClient';

// 1. Obtener el slug de la URL
const { slug } = Astro.params;

// 2. Mapear slug a nombre de categoría (sensible a mayúsculas/minúsculas de tu DB)
const categoryMap = {
  ninas: 'Niñas', // Asegúrate que estos coincidan EXACTAMENTE con tu DB
  ninos: 'Niños',
  veterinarios: 'Mascotas' // Asumiendo que usas 'Mascotas' en la DB
};
const categoryName = categoryMap[slug] || slug; // Usar slug como fallback si no hay mapeo

// Título de la página (más descriptivo)
let pageTitle = `Catálogo - ${categoryName}`;
if (categoryName === 'Mascotas') pageTitle = 'Catálogo - Carnets de Control para Mascotas';
else if (categoryName === 'Niños') pageTitle = 'Catálogo - Carnets de Control para Niños';
else if (categoryName === 'Niñas') pageTitle = 'Catálogo - Carnets de Control para Niñas';

// 3. Cargar productos desde Supabase usando la categoría mapeada
let products = [];
let fetchError = null;

try {
  const { data, error } = await supabase
    .from('products')
    .select('id, name, category, image_url_ref, image_url_full') // Seleccionar columnas necesarias
    .eq('category', categoryName) // Filtrar por la categoría obtenida del slug
    .order('created_at', { ascending: false });

  if (error) throw error;
  products = data || [];
} catch (err) {
  console.error(`Error al cargar productos para categoría '${categoryName}':`, err);
  fetchError = err;
}

// 4. Definir todas las categorías para la navegación
const allCategories = [
  { name: 'Niños', href: '/categoria/ninos', id: 'Niños' }, // Usar '/categoria/...'
  { name: 'Niñas', href: '/categoria/ninas', id: 'Niñas' },
  { name: 'Mascotas', href: '/categoria/veterinarios', id: 'Mascotas' },
];
const currentCategory = categoryName; // Para marcar el enlace activo
---

<Layout title={pageTitle}>
  <main class="catalog-page">
    <div class="container">
      <div class="catalog-header">
        <h1>{pageTitle.replace('Catálogo - ', '')}</h1> {/* Título más corto */}
        {/* Podrías añadir subtítulos específicos por categoría si quieres */}
        {categoryName === 'Mascotas' && <p class="subtitle">Lleva un registro de vacunas y visitas 🐾</p>}
        {categoryName === 'Niños' && <p class="subtitle">Un recuerdo especial para su crecimiento.</p>}
        {categoryName === 'Niñas' && <p class="subtitle">Diseños encantadores para ellas.</p>}
      </div>

      {/* Navegación de Categorías */}
      <nav class="category-nav">
        <ul>
          {allCategories.map(cat => (
            <li>
              <a href={cat.href} class:list={{ active: cat.id === currentCategory }}>
                {cat.name}
              </a>
            </li>
          ))}
        </ul>
      </nav>

      {/* Listado de productos */}
      {fetchError ? (
        <p class="error">
          <strong>Error al cargar productos:</strong> {fetchError.message || 'Error desconocido.'}
          <br /><small>(Ver consola del servidor y RLS en Supabase)</small>
        </p>
      ) : (
        <div class="product-grid">
          {products.length > 0 ? (
            products.map(product => (
              <>
                {/* 5. Usar los componentes correctamente */}
                <ProductCard product={product} />
                <ProductFullCard product={product} />
              </>
            ))
          ) : (
            <p class="no-products-message">
              Aún no hay productos en la categoría "{categoryName}". ¡Vuelve pronto!
            </p>
          )}
        </div>
      )}
    </div>
  </main>
</Layout>

<style>
/* Estilos similares a veterinarios.astro */
.catalog-page { padding: 4rem 0; background: #fef7fb; }
.container { max-width: 1200px; margin: 0 auto; padding: 0 1.5rem; }
.catalog-header { text-align: center; margin-bottom: 2.5rem; }
h1 { font-size: 2.2rem; color: #333; }
.subtitle { color: #666; margin-top: 0.5rem; }
.category-nav { display: flex; justify-content: center; margin-bottom: 3rem; }
.category-nav ul { display: flex; gap: 0.5rem; padding: 0; list-style: none; flex-wrap: wrap; justify-content: center; }
.category-nav a { padding: 0.6rem 1.4rem; border-radius: 50px; text-decoration: none; font-weight: 600; color: #444; border: 2px solid transparent; transition: all 0.25s ease; }
.category-nav a:hover { border-color: #f0ce0c; }
.category-nav a.active { background: #f0ce0c; color: #333; border-color: #f0ce0c; font-weight: 700; }
.product-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 2rem; }
.no-products-message, .error { grid-column: 1 / -1; text-align: center; color: #777; font-size: 1.1rem; padding: 3rem 1rem; background: #fff; border: 1px dashed #ddd; border-radius: 12px; }
.error { color: red; background: #ffeaea; border-color: red; }
.error small { color: #555; display: block; margin-top: 0.5rem; }
</style>