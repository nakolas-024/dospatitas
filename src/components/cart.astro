---
// Cart.astro
---

<div id="cart-panel" class="cart-window" aria-hidden="true">
  <div class="panel-header">
    <h3>Tu Pedido</h3>
    <button id="close-cart-btn" class="close-btn" aria-label="Cerrar carrito">√ó</button>
  </div>

  <div id="cart-items-container" class="cart-items-container">
    <p class="empty-cart-message">Tu carrito est√° vac√≠o.</p>
  </div>

  <div class="panel-footer">
    <a id="whatsapp-checkout-btn" href="#" class="whatsapp-btn disabled" target="_blank" rel="noopener noreferrer">
      Hacer Pedido por WhatsApp
    </a>
  </div>
</div>

<!-- Bot√≥n flotante -->
<button id="open-cart" class="floating-btn cart-btn" aria-label="Ver carrito">üõí</button>

<script type="module">
  const cartPanel = document.getElementById('cart-panel');
  const openCartBtn = document.getElementById('open-cart');
  const closeCartBtn = document.getElementById('close-cart-btn');
  const itemsContainer = document.getElementById('cart-items-container');
  const checkoutBtn = document.getElementById('whatsapp-checkout-btn');
  const WHATSAPP_NUMBER = '56958473816';

  if (!cartPanel || !closeCartBtn || !openCartBtn || !itemsContainer || !checkoutBtn) return;

  // Abrir y cerrar panel
  openCartBtn.addEventListener('click', () => cartPanel.classList.add('is-open'));
  closeCartBtn.addEventListener('click', () => cartPanel.classList.remove('is-open'));

  // Actualizar contenido del carrito
  const updateCart = () => {
    let cart = JSON.parse(localStorage.getItem('cart')) || [];
    if (!Array.isArray(cart)) cart = [];

    if (cart.length === 0) {
      itemsContainer.innerHTML = '<p class="empty-cart-message">Tu carrito est√° vac√≠o.</p>';
      checkoutBtn.classList.add('disabled');
      checkoutBtn.href = '#';
      return;
    }

    let html = '';
    cart.forEach(item => {
      html += `
        <div class="cart-card" data-id="${item.id}">
          <div class="cart-card-body">
            <p class="cart-item-name">${item.name}</p>
            <div class="cart-controls">
              <button class="btn-qty" data-action="decrease">‚àí</button>
              <span class="qty-count">${item.quantity}</span>
              <button class="btn-qty" data-action="increase">+</button>
              <button class="btn-remove" aria-label="Eliminar">√ó</button>
            </div>
          </div>
        </div>
      `;
    });
    itemsContainer.innerHTML = html;
    checkoutBtn.classList.remove('disabled');
    updateWhatsappLink(cart);
  };

  // Link WhatsApp
  const updateWhatsappLink = (cart) => {
    let text = "Hola! Quiero pedir los siguientes productos:%0A";
    cart.forEach(i => { text += `- ${i.name} x${i.quantity}%0A`; });
    checkoutBtn.href = cart.length ? `https://wa.me/${WHATSAPP_NUMBER}?text=${text}` : '#';
  };

  // Modificar cantidad
  const modifyQuantity = (id, action) => {
    let cart = JSON.parse(localStorage.getItem('cart')) || [];
    const index = cart.findIndex(p => p.id == id);
    if (index > -1) {
      cart[index].quantity = action === 'increase' ? cart[index].quantity + 1 : cart[index].quantity -1;
      if (cart[index].quantity < 1) cart.splice(index,1);
      localStorage.setItem('cart', JSON.stringify(cart));
      updateCart();
    }
  };

  // Eliminar producto
  const removeItem = (id) => {
    let cart = JSON.parse(localStorage.getItem('cart')) || [];
    const index = cart.findIndex(p => p.id == id);
    if (index > -1) {
      cart.splice(index,1);
      localStorage.setItem('cart', JSON.stringify(cart));
      updateCart();
    }
  };

  // Eventos de los botones del carrito
  itemsContainer.addEventListener('click', e => {
    const card = e.target.closest('.cart-card');
    if (!card) return;
    const id = card.dataset.id;
    if (e.target.matches('.btn-qty')) modifyQuantity(id, e.target.dataset.action);
    if (e.target.matches('.btn-remove')) removeItem(id);
  });

  // Inicializar
  updateCart();
</script>

<style is:global>
  :root {
    --color-primary: #ff7bb0;
    --color-accent: #ffafcc;
    --color-bg: #fff;
    --color-text: #333;
    --font-main: 'Poppins', sans-serif;
  }

  body { font-family: var(--font-main); margin:0; color: var(--color-text); background: var(--color-bg); }

  /* Bot√≥n flotante */
  .floating-btn {
    position: fixed; bottom: 25px; width: 65px; height: 65px; border-radius: 50%;
    display:flex; align-items:center; justify-content:center;
    font-size:1.6rem; color:#fff; border:none; cursor:pointer;
    box-shadow:0 8px 20px rgba(0,0,0,0.25); z-index:100; transition: all 0.3s ease;
  }
  .floating-btn:hover { transform: translateY(-5px) scale(1.05); box-shadow:0 10px 25px rgba(0,0,0,0.3);}
  .cart-btn { right:25px; background: linear-gradient(135deg, var(--color-primary), var(--color-accent)); }

  /* Panel carrito */
  .cart-window {
    position: fixed; top: 80px; right: -360px; width: 340px; max-width:90%; height: calc(100% - 100px);
    background: #fff; box-shadow: -4px 0 20px rgba(0,0,0,0.25);
    transition: right 0.3s ease; z-index: 999; display:flex; flex-direction:column; border-radius:15px 0 0 15px;
  }
  .cart-window.is-open { right:0; }

  .panel-header { display:flex; justify-content:space-between; align-items:center; padding:1rem; border-bottom:1px solid #ddd;}
  .panel-header h3 { margin:0; font-size:1.2rem; }
  .close-btn { background:none; border:none; font-size:1.5rem; cursor:pointer; }

  .cart-items-container { flex:1; overflow-y:auto; padding:1rem; }
  .cart-card { background:#fff0f6; border-radius:12px; padding:0.8rem; margin-bottom:0.8rem; display:flex; flex-direction:column; gap:0.5rem; box-shadow:0 2px 6px rgba(0,0,0,0.08);}
  .cart-card-body { display:flex; justify-content:space-between; align-items:center; }
  .cart-item-name { font-weight:600; font-size:0.95rem; color:#374151; margin:0; }
  .cart-controls { display:flex; align-items:center; gap:0.4rem; }
  .btn-qty { width:28px; height:28px; border:none; border-radius:6px; background:var(--color-accent); color:#fff; font-weight:600; cursor:pointer; display:flex; align-items:center; justify-content:center; transition:all 0.2s ease;}
  .btn-qty:hover { background:var(--color-primary); transform:translateY(-2px);}
  .qty-count { font-weight:600; min-width:18px; text-align:center; }

  .btn-remove { width:28px; height:28px; border:none; background:#f44336; color:#fff; border-radius:6px; cursor:pointer; font-size:1rem; display:flex; align-items:center; justify-content:center; transition:all 0.2s ease;}
  .btn-remove:hover { transform:translateY(-2px); background:#d32f2f; }

  .panel-footer { padding:1rem; border-top:1px solid #ddd; }
  .panel-footer .whatsapp-btn { display:block; text-align:center; background:#25d366; color:#fff; padding:0.8rem; border-radius:50px; text-decoration:none; font-weight:600; }
  .panel-footer .whatsapp-btn.disabled { opacity:0.6; pointer-events:none; }

  .empty-cart-message { text-align:center; color:#555; margin-top:2rem; }
</style>
